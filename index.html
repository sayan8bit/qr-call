<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PeerJS Video Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
      }
      video {
        width: 45%;
        border: 2px solid black;
        margin: 10px;
      }
      #video-box {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <h2>PeerJS Video Call</h2>
    <p>Your ID: <span id="my-id">Loading...</span></p>

    <input type="text" id="peer-id-input" placeholder="Enter friend's ID" />
    <button id="call-btn">Start Call</button>

    <div id="video-box">
      <video id="local-video" autoplay muted></video>
      <video id="remote-video" autoplay></video>
    </div>

    <script>
      // Create a fixed ID (won't change on refresh)
      let myId = localStorage.getItem("myFixedPeerId");
      if (!myId) {
        myId = "user-" + Math.random().toString(36).substring(2, 8);
        localStorage.setItem("myFixedPeerId", myId);
      }

      const peer = new Peer(myId);
      let localStream = null;

      const myIdSpan = document.getElementById("my-id");
      const callBtn = document.getElementById("call-btn");
      const peerIdInput = document.getElementById("peer-id-input");
      const localVideo = document.getElementById("local-video");
      const remoteVideo = document.getElementById("remote-video");

      // Display my peer ID
      peer.on("open", (id) => {
        myIdSpan.textContent = id;
      });

      // Get camera/mic access
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localStream = stream;
          localVideo.srcObject = stream;
        })
        .catch((err) => {
          alert("Could not access camera/mic: " + err.message);
        });

      // When someone calls me
      peer.on("call", (call) => {
        if (!localStream) return;
        call.answer(localStream);
        call.on("stream", (remoteStream) => {
          remoteVideo.srcObject = remoteStream;
        });
      });

      // When I call someone
      callBtn.onclick = () => {
        const peerId = peerIdInput.value.trim();
        if (!peerId || !localStream) {
          alert("Enter a valid ID and allow camera/mic access");
          return;
        }

        const call = peer.call(peerId, localStream);
        call.on("stream", (remoteStream) => {
          remoteVideo.srcObject = remoteStream;
        });

        call.on("error", (err) => {
          alert("Call failed: " + err.message);
        });
      };
    </script>
  </body>
</html>
