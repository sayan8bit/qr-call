<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Audio Call with PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 500px;
        margin: auto;
        padding: 20px;
      }
      input,
      button {
        margin: 6px 0;
        padding: 8px;
        width: 100%;
      }
      #users div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #ddd;
        padding: 5px;
        margin: 5px 0;
      }
      #callStatus {
        margin-top: 10px;
        font-weight: bold;
      }
      #qrCanvas {
        margin-top: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h2>üîä PeerJS Audio Call</h2>
    <p>Your ID: <b id="myId"></b></p>
    <div id="qrCanvas"></div>

    <input id="newUserId" placeholder="Enter user ID to add" />
    <button onclick="addUser()">‚ûï Add User</button>

    <div id="users"></div>

    <div id="callStatus"></div>

    <audio id="remoteAudio" autoplay></audio>

    <script>
      let myId =
        localStorage.getItem("fixedPeerId") ||
        "user-" + Math.random().toString(36).substr(2, 6);
      localStorage.setItem("fixedPeerId", myId);
      document.getElementById("myId").textContent = myId;

      // QR
      QRCode.toCanvas(
        document.createElement("canvas"),
        myId,
        function (error, canvas) {
          if (!error) document.getElementById("qrCanvas").appendChild(canvas);
        }
      );

      const peer = new Peer(myId, {
        host: "peerjs.com",
        secure: true,
        port: 443,
      });

      const remoteAudio = document.getElementById("remoteAudio");
      const callStatus = document.getElementById("callStatus");

      let localStream;
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        localStream = stream;
      });

      peer.on("call", (call) => {
        const accept = confirm("Incoming call from " + call.peer + ". Accept?");
        if (accept) {
          call.answer(localStream);
          callStatus.innerText = "‚úÖ Call answered from " + call.peer;

          call.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
          });

          call.on("close", () => {
            callStatus.innerText = "‚ùå Call ended";
          });
        } else {
          call.close();
        }
      });

      function addUser() {
        const id = document.getElementById("newUserId").value.trim();
        if (!id) return alert("Enter a user ID");
        let saved = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        if (!saved.includes(id)) {
          saved.push(id);
          localStorage.setItem("savedUsers", JSON.stringify(saved));
          renderUsers();
        }
        document.getElementById("newUserId").value = "";
      }

      function renderUsers() {
        const usersDiv = document.getElementById("users");
        usersDiv.innerHTML = "";
        let saved = JSON.parse(localStorage.getItem("savedUsers") || "[]");

        saved.forEach((id) => {
          const div = document.createElement("div");
          div.innerHTML = `
          <span>${id}</span>
          <button onclick="callUser('${id}')">üìû Call</button>
          <button onclick="removeUser('${id}')">‚ùå</button>
        `;
          usersDiv.appendChild(div);
        });
      }

      function removeUser(id) {
        let saved = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        saved = saved.filter((x) => x !== id);
        localStorage.setItem("savedUsers", JSON.stringify(saved));
        renderUsers();
      }

      function callUser(userId) {
        if (!localStream) return alert("Microphone not ready");
        callStatus.innerText = "üìû Calling " + userId + "...";

        const call = peer.call(userId, localStream);
        call.on("stream", (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          callStatus.innerText = "‚úÖ Call connected with " + userId;
        });

        call.on("close", () => {
          callStatus.innerText = "‚ùå Call ended";
        });

        call.on("error", (err) => {
          callStatus.innerText = "‚ö†Ô∏è Call failed: " + err.message;
        });
      }

      renderUsers();
    </script>
  </body>
</html>
