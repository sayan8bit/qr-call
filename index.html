<!DOCTYPE html>
<html>
  <head>
    <title>PeerJS Audio Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial;
        margin: 20px;
      }
      #users button {
        margin: 5px;
      }
      #incomingCall {
        display: none;
        padding: 10px;
        background: #eee;
        margin-top: 10px;
      }
      #callControls {
        display: none;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h2>Your ID: <span id="myId"></span></h2>
    <input type="text" id="addUserInput" placeholder="User ID to add" />
    <button onclick="addUser()">Add User</button>
    <h3>Saved Users:</h3>
    <div id="users"></div>

    <div id="incomingCall">
      <p>Incoming call from <span id="incomingId"></span></p>
      <button onclick="answerCall()">Answer</button>
      <button onclick="declineCall()">Decline</button>
    </div>

    <div id="callControls">
      <p>In Call with: <span id="inCallWith"></span></p>
      <p>Call Duration: <span id="callTime">00:00</span></p>
      <button onclick="endCall()">End Call</button>
    </div>

    <audio
      id="ringtone"
      src="https://assets.mixkit.co/sfx/download/mixkit-classic-doorbell-1516.mp3"
      preload="auto"
    ></audio>
    <audio id="remoteAudio" autoplay></audio>

    <script>
      let myId = localStorage.getItem("myPeerId");
      if (!myId) {
        myId = "user-" + Math.random().toString(36).substr(2, 6);
        localStorage.setItem("myPeerId", myId);
      }

      document.getElementById("myId").textContent = myId;

      const peer = new Peer(myId);
      let currentCall = null;
      let callTimerInterval = null;
      let seconds = 0;
      let ringtone = document.getElementById("ringtone");

      peer.on("open", () => {
        console.log("Peer connected");
      });

      peer.on("call", (call) => {
        ringtone.play();
        window.incomingCall = call;
        document.getElementById("incomingId").textContent = call.peer;
        document.getElementById("incomingCall").style.display = "block";
      });

      function answerCall() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          ringtone.pause();
          ringtone.currentTime = 0;

          window.incomingCall.answer(stream);
          setupCall(window.incomingCall, stream);
          document.getElementById("incomingCall").style.display = "none";
        });
      }

      function declineCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        window.incomingCall.close();
        document.getElementById("incomingCall").style.display = "none";
      }

      function addUser() {
        const input = document.getElementById("addUserInput");
        const userId = input.value.trim();
        if (!userId) return;

        let users = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        if (!users.includes(userId)) {
          users.push(userId);
          localStorage.setItem("savedUsers", JSON.stringify(users));
          renderUsers();
        }
        input.value = "";
      }

      function renderUsers() {
        const users = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        const container = document.getElementById("users");
        container.innerHTML = "";
        users.forEach((uid) => {
          const btn = document.createElement("button");
          btn.textContent = "Call " + uid;
          btn.onclick = () => startCall(uid);
          container.appendChild(btn);
        });
      }

      function startCall(userId) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          const call = peer.call(userId, stream);
          setupCall(call, stream);
        });
      }

      function setupCall(call, localStream) {
        if (currentCall) currentCall.close();
        currentCall = call;

        call.on("stream", (remoteStream) => {
          const remoteAudio = document.getElementById("remoteAudio");
          remoteAudio.srcObject = remoteStream;
          remoteAudio.play();
          document.getElementById("inCallWith").textContent = call.peer;
          document.getElementById("callControls").style.display = "block";
          startTimer();
        });

        call.on("close", () => {
          endCall();
        });
      }

      function endCall() {
        if (currentCall) currentCall.close();
        currentCall = null;
        document.getElementById("callControls").style.display = "none";
        stopTimer();
      }

      function startTimer() {
        seconds = 0;
        callTimerInterval = setInterval(() => {
          seconds++;
          let min = String(Math.floor(seconds / 60)).padStart(2, "0");
          let sec = String(seconds % 60).padStart(2, "0");
          document.getElementById("callTime").textContent = `${min}:${sec}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(callTimerInterval);
        document.getElementById("callTime").textContent = "00:00";
      }

      renderUsers();
    </script>
  </body>
</html>
