<!DOCTYPE html>
<html>
  <head>
    <title>Voice Call with PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 400px;
        margin: auto;
        padding: 20px;
        background: #f0f0f0;
      }
      h2 {
        text-align: center;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
      }
      .call-controls,
      .incoming-call {
        display: none;
        margin-top: 15px;
      }
      .status {
        margin-top: 10px;
        text-align: center;
        font-weight: bold;
        color: green;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ“ž PeerJS Voice Call</h2>

    <p><strong>Your ID:</strong> <span id="yourId">Loading...</span></p>

    <input type="text" id="peerIdInput" placeholder="Enter Peer ID to call" />
    <button id="callBtn">Start Call</button>

    <div class="incoming-call" id="incomingCall">
      <p><strong>Incoming call...</strong></p>
      <button id="acceptBtn">Accept</button>
      <button id="declineBtn">Decline</button>
    </div>

    <div class="call-controls" id="callControls">
      <p><strong>In Call with:</strong> <span id="connectedWith"></span></p>
      <button id="endCallBtn">End Call</button>
    </div>

    <p class="status" id="status"></p>

    <script>
      const yourIdSpan = document.getElementById("yourId");
      const peerIdInput = document.getElementById("peerIdInput");
      const callBtn = document.getElementById("callBtn");
      const incomingCallDiv = document.getElementById("incomingCall");
      const acceptBtn = document.getElementById("acceptBtn");
      const declineBtn = document.getElementById("declineBtn");
      const callControls = document.getElementById("callControls");
      const endCallBtn = document.getElementById("endCallBtn");
      const connectedWithSpan = document.getElementById("connectedWith");
      const status = document.getElementById("status");

      const peer = new Peer({
        config: { iceServers: [{ url: "stun:stun.l.google.com:19302" }] },
      });

      let currentCall = null;

      peer.on("open", (id) => {
        yourIdSpan.textContent = id;
      });

      peer.on("call", (call) => {
        currentCall = call;
        incomingCallDiv.style.display = "block";

        acceptBtn.onclick = () => {
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((stream) => {
              call.answer(stream);
              handleCallStream(call, stream);
            });
          incomingCallDiv.style.display = "none";
        };

        declineBtn.onclick = () => {
          call.close();
          currentCall = null;
          incomingCallDiv.style.display = "none";
        };
      });

      callBtn.onclick = () => {
        const otherId = peerIdInput.value;
        if (!otherId) return alert("Enter a Peer ID!");

        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          const call = peer.call(otherId, stream);
          currentCall = call;
          handleCallStream(call, stream);
        });
      };

      endCallBtn.onclick = () => {
        if (currentCall) {
          currentCall.close();
          currentCall = null;
          callControls.style.display = "none";
          status.textContent = "Call ended.";
        }
      };

      function handleCallStream(call, localStream) {
        status.textContent = "In call...";
        connectedWithSpan.textContent = call.peer;
        callControls.style.display = "block";

        call.on("stream", (remoteStream) => {
          const audio = new Audio();
          audio.srcObject = remoteStream;
          audio.play();
        });

        call.on("close", () => {
          callControls.style.display = "none";
          status.textContent = "Call ended.";
          currentCall = null;
        });
      }
    </script>
  </body>
</html>
