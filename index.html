<!DOCTYPE html>
<html>
  <head>
    <title>PeerJS Video Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial;
        background: #f2f2f2;
        text-align: center;
        padding: 30px;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
        width: 250px;
        font-size: 16px;
      }
      video {
        width: 45%;
        max-width: 300px;
        margin: 10px;
        border: 2px solid #444;
        border-radius: 10px;
      }
      #status {
        font-weight: bold;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h2>üìπ PeerJS Video Call</h2>
    <p><strong>Your ID:</strong> <span id="my-id">Loading...</span></p>
    <input type="text" id="peer-id" placeholder="Enter peer ID to call" />
    <br />
    <button onclick="startCall()">üìû Call</button>
    <button onclick="endCall()">‚ùå End Call</button>
    <p>Status: <span id="status">Idle</span></p>
    <p>Timer: <span id="timer">00:00</span></p>

    <div>
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
      let localStream = null;
      let currentCall = null;
      let timer = null;
      let startTime = null;

      // Get fixed ID from localStorage
      let myId = localStorage.getItem("peer-fixed-id");
      if (!myId) {
        myId = "user-" + Math.random().toString(36).substring(2, 6);
        localStorage.setItem("peer-fixed-id", myId);
      }

      const peer = new Peer(myId);

      peer.on("open", (id) => {
        document.getElementById("my-id").textContent = id;
      });

      peer.on("call", (call) => {
        updateStatus("Incoming Call...");
        navigator.mediaDevices
          .getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            document.getElementById("localVideo").srcObject = stream;

            call.answer(stream);
            currentCall = call;

            call.on("stream", (remoteStream) => {
              playRemoteStream(remoteStream);
            });

            call.on("close", () => {
              cleanup();
            });
          })
          .catch((err) => {
            updateStatus("Permission Denied");
            console.error(err);
          });
      });

      function startCall() {
        const remoteId = document.getElementById("peer-id").value;
        if (!remoteId) return alert("Enter a peer ID to call!");

        navigator.mediaDevices
          .getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            document.getElementById("localVideo").srcObject = stream;

            const call = peer.call(remoteId, stream);
            currentCall = call;

            updateStatus("Calling...");

            call.on("stream", (remoteStream) => {
              playRemoteStream(remoteStream);
            });

            call.on("close", () => {
              cleanup();
            });
          })
          .catch((err) => {
            updateStatus("Permission Denied");
            console.error(err);
          });
      }

      function playRemoteStream(stream) {
        const remoteVideo = document.getElementById("remoteVideo");
        remoteVideo.srcObject = stream;
        remoteVideo.play().catch((err) => console.error("Play error:", err));
        updateStatus("In Call");
        startTimer();
      }

      function endCall() {
        if (currentCall) {
          currentCall.close();
        }
        cleanup();
      }

      function cleanup() {
        updateStatus("Call Ended");
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          document.getElementById("localVideo").srcObject = null;
        }
        document.getElementById("remoteVideo").srcObject = null;
        stopTimer();
      }

      function updateStatus(text) {
        document.getElementById("status").innerText = text;
      }

      function startTimer() {
        startTime = Date.now();
        timer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const secs = String(elapsed % 60).padStart(2, "0");
          document.getElementById("timer").innerText = `${mins}:${secs}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timer);
        document.getElementById("timer").innerText = "00:00";
      }
    </script>
  </body>
</html>
