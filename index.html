<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeerJS Audio Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial;
        background: #111;
        color: #fff;
        margin: 0;
        padding: 20px;
      }
      #container {
        max-width: 500px;
        margin: auto;
        background: #222;
        padding: 20px;
        border-radius: 10px;
      }
      input,
      button {
        padding: 10px;
        margin: 5px 0;
        width: 100%;
        font-size: 16px;
        border: none;
        border-radius: 5px;
      }
      button {
        background: #4caf50;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #45a049;
      }
      .user {
        display: flex;
        justify-content: space-between;
        background: #333;
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        align-items: center;
      }
      .actions button {
        background: #f44336;
        padding: 5px 10px;
      }
      #call-status {
        margin: 10px 0;
        font-weight: bold;
      }
      .hidden {
        display: none;
      }
      .inline {
        display: inline;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h2>üîä PeerJS Audio Call</h2>
      <p><strong>Your ID:</strong> <span id="my-id">Loading...</span></p>

      <input type="text" id="userIdInput" placeholder="Enter user ID to call" />
      <button onclick="addUser()">‚ûï Add User</button>

      <div id="user-list"></div>

      <h3 id="call-status">Status: Idle</h3>
      <div id="in-call-actions" class="hidden">
        <button onclick="endCall()">‚ùå End Call</button>
        <p id="timer">‚è± 00:00</p>
      </div>

      <div id="incoming-call" class="hidden">
        <p>üìû Incoming Call from <span id="caller-id"></span></p>
        <button onclick="answerCall()">‚úÖ Answer</button>
        <button onclick="declineCall()">‚ùå Decline</button>
      </div>

      <audio id="ringtone" loop>
        <source
          src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_ringtones.ogg"
          type="audio/ogg"
        />
      </audio>
    </div>

    <script>
      let peer;
      let currentCall = null;
      let myId =
        localStorage.getItem("peer-id") ||
        "user-" + Math.floor(Math.random() * 10000);
      localStorage.setItem("peer-id", myId);
      document.getElementById("my-id").textContent = myId;

      const ringtone = document.getElementById("ringtone");
      const callStatus = document.getElementById("call-status");
      const incomingDiv = document.getElementById("incoming-call");
      const callerIdSpan = document.getElementById("caller-id");
      const inCallActions = document.getElementById("in-call-actions");
      const timerDisplay = document.getElementById("timer");
      let callTimerInterval = null;

      peer = new Peer(myId, {
        host: "peerjs.com",
        secure: true,
        port: 443,
      });

      peer.on("open", (id) => {
        console.log("Connected with ID:", id);
      });

      peer.on("call", (call) => {
        currentCall = call;
        ringtone.play();
        callerIdSpan.textContent = call.peer;
        incomingDiv.classList.remove("hidden");

        // Handle if remote closes before answering
        call.on("close", () => {
          endCall();
        });
      });

      function answerCall() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          currentCall.answer(stream);
          setupCall(currentCall, stream);
          ringtone.pause();
          incomingDiv.classList.add("hidden");
        });
      }

      function declineCall() {
        if (currentCall) currentCall.close();
        ringtone.pause();
        incomingDiv.classList.add("hidden");
      }

      function addUser() {
        const id = document.getElementById("userIdInput").value.trim();
        if (!id) return;
        let users = JSON.parse(localStorage.getItem("saved-users") || "[]");
        if (!users.includes(id)) {
          users.push(id);
          localStorage.setItem("saved-users", JSON.stringify(users));
        }
        document.getElementById("userIdInput").value = "";
        renderUsers();
      }

      function renderUsers() {
        const users = JSON.parse(localStorage.getItem("saved-users") || "[]");
        const list = document.getElementById("user-list");
        list.innerHTML = "";
        users.forEach((id) => {
          const div = document.createElement("div");
          div.className = "user";
          div.innerHTML = `
          <span>${id}</span>
          <div class="actions">
            <button onclick="callUser('${id}')">üìû</button>
            <button onclick="removeUser('${id}')">‚ùå</button>
          </div>
        `;
          list.appendChild(div);
        });
      }

      function removeUser(id) {
        let users = JSON.parse(localStorage.getItem("saved-users") || "[]");
        users = users.filter((u) => u !== id);
        localStorage.setItem("saved-users", JSON.stringify(users));
        renderUsers();
      }

      function callUser(id) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          const call = peer.call(id, stream);
          currentCall = call;
          setupCall(call, stream);
        });
      }

      function setupCall(call, localStream) {
        callStatus.textContent = "üìû In Call with " + call.peer;
        inCallActions.classList.remove("hidden");
        startTimer();

        call.on("stream", (remoteStream) => {
          const audio = new Audio();
          audio.srcObject = remoteStream;
          audio.play();
        });

        call.on("close", () => {
          endCall();
        });
      }

      function endCall() {
        if (currentCall) {
          currentCall.close();
          currentCall = null;
        }
        callStatus.textContent = "Status: Idle";
        inCallActions.classList.add("hidden");
        stopTimer();
      }

      let seconds = 0;
      function startTimer() {
        seconds = 0;
        timerDisplay.textContent = "‚è± 00:00";
        callTimerInterval = setInterval(() => {
          seconds++;
          let mins = String(Math.floor(seconds / 60)).padStart(2, "0");
          let secs = String(seconds % 60).padStart(2, "0");
          timerDisplay.textContent = `‚è± ${mins}:${secs}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(callTimerInterval);
        timerDisplay.textContent = "‚è± 00:00";
      }

      renderUsers();
    </script>
  </body>
</html>
