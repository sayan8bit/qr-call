<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PeerJS Audio Call (Fixed Short ID)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 30px;
        background-color: #f0f0f0;
      }
      input,
      button {
        padding: 10px;
        margin: 10px;
        font-size: 16px;
      }
      #my-id {
        font-weight: bold;
        color: green;
      }
      audio {
        margin-top: 20px;
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h2>ðŸŽ§ PeerJS Audio Call</h2>
    <p>Your ID: <span id="my-id">Loading...</span></p>
    <input type="text" id="peer-id" placeholder="Enter Peer ID to call" />
    <br />
    <button id="callBtn">Call</button>
    <button id="endBtn" disabled>End Call</button>
    <audio id="remoteAudio" autoplay controls></audio>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
      const myIdSpan = document.getElementById("my-id");
      const callBtn = document.getElementById("callBtn");
      const endBtn = document.getElementById("endBtn");
      const peerIdInput = document.getElementById("peer-id");
      const remoteAudio = document.getElementById("remoteAudio");

      let localStream;
      let currentCall;

      // Generate or load a short persistent ID
      function getOrCreatePeerID() {
        const savedId = localStorage.getItem("peer-fixed-id");
        if (savedId) return savedId;
        const newId = generateShortID(5);
        localStorage.setItem("peer-fixed-id", newId);
        return newId;
      }

      // Generate short random ID
      function generateShortID(length) {
        const chars =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      const myPeerID = getOrCreatePeerID();

      // Create PeerJS with fixed ID
      const peer = new Peer(myPeerID);

      peer.on("open", (id) => {
        myIdSpan.textContent = id;
      });

      peer.on("call", async (call) => {
        const stream = await getAudioStream();
        call.answer(stream);
        handleCall(call, stream);
      });

      callBtn.onclick = async () => {
        const peerId = peerIdInput.value.trim();
        if (!peerId) return alert("Please enter a valid Peer ID!");

        const stream = await getAudioStream();
        const call = peer.call(peerId, stream);
        handleCall(call, stream);
      };

      endBtn.onclick = () => {
        if (currentCall) {
          currentCall.close();
          currentCall = null;
          remoteAudio.srcObject = null;
          endBtn.disabled = true;
        }
      };

      function handleCall(call, stream) {
        currentCall = call;

        call.on("stream", (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          endBtn.disabled = false;
        });

        call.on("close", () => {
          remoteAudio.srcObject = null;
          endBtn.disabled = true;
          currentCall = null;
        });

        call.on("error", (err) => {
          console.error("Call error:", err);
          alert("Call failed.");
          endBtn.disabled = true;
        });
      }

      async function getAudioStream() {
        if (!localStream) {
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
          } catch (err) {
            alert("Microphone permission is required.");
            throw err;
          }
        }
        return localStream;
      }
    </script>
  </body>
</html>
