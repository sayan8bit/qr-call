<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Real-Time Audio Call</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1em;
        background: #f0f0f0;
      }
      input,
      button {
        padding: 0.5em;
        margin: 0.5em 0;
      }
      .user-list button {
        display: block;
        margin: 0.3em 0;
      }
      #incomingCallUI {
        display: none;
        padding: 1em;
        background: #fff;
        border: 1px solid #ccc;
        margin-top: 1em;
      }
      #callControls {
        display: none;
        margin-top: 1em;
      }
      audio {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>Real-Time Audio Call</h2>

    <div><strong>Your ID:</strong> <span id="myId">Loading...</span></div>

    <input type="text" id="peerIdInput" placeholder="Enter Peer ID" />
    <button onclick="addUser()">Add User</button>

    <h4>Saved Users</h4>
    <div class="user-list" id="userList"></div>

    <div id="incomingCallUI">
      <p><strong>Incoming Call from:</strong> <span id="callerId"></span></p>
      <button onclick="answerCall()">Answer</button>
      <button onclick="declineCall()">Decline</button>
    </div>

    <div id="callControls">
      <p><strong>Call Timer:</strong> <span id="callTimer">00:00</span></p>
      <button onclick="endCall()">End Call</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
    <audio
      id="ringtone"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7209f0f7c1.mp3?filename=phone-ringtone-141855.mp3"
      loop
    ></audio>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
      const myIdSpan = document.getElementById("myId");
      const peerIdInput = document.getElementById("peerIdInput");
      const userList = document.getElementById("userList");
      const incomingCallUI = document.getElementById("incomingCallUI");
      const callerIdSpan = document.getElementById("callerId");
      const remoteAudio = document.getElementById("remoteAudio");
      const ringtone = document.getElementById("ringtone");
      const callControls = document.getElementById("callControls");
      const callTimerSpan = document.getElementById("callTimer");

      let peerId =
        localStorage.getItem("myPeerId") ||
        "user_" + Math.floor(Math.random() * 10000);
      localStorage.setItem("myPeerId", peerId);
      myIdSpan.textContent = peerId;

      const peer = new Peer(peerId, {
        debug: 2,
        config: {
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        },
      });

      let currentCall = null;
      let localStream = null;
      let callStartTime = null;
      let callTimerInterval = null;

      function addUser() {
        const id = peerIdInput.value.trim();
        if (!id) return;

        let users = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        if (!users.includes(id)) {
          users.push(id);
          localStorage.setItem("savedUsers", JSON.stringify(users));
          updateUserList();
        }

        peerIdInput.value = "";
      }

      function updateUserList() {
        const users = JSON.parse(localStorage.getItem("savedUsers") || "[]");
        userList.innerHTML = "";
        users.forEach((id) => {
          const btn = document.createElement("button");
          btn.textContent = `Call ${id}`;
          btn.onclick = () => startCall(id);
          userList.appendChild(btn);
        });
      }

      updateUserList();

      async function startCall(targetId) {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const call = peer.call(targetId, localStream);
        handleCall(call);
      }

      function answerCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        incomingCallUI.style.display = "none";

        if (pendingCall) {
          pendingCall.answer(localStream);
          handleCall(pendingCall);
          pendingCall = null;
        }
      }

      function declineCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        incomingCallUI.style.display = "none";
        if (pendingCall) {
          pendingCall.close();
          pendingCall = null;
        }
      }

      function endCall() {
        if (currentCall) {
          currentCall.close();
          currentCall = null;
          stopCallTimer();
          callControls.style.display = "none";
          remoteAudio.srcObject = null;
        }
      }

      function handleCall(call) {
        currentCall = call;
        callControls.style.display = "block";
        callStartTime = Date.now();
        startCallTimer();

        call.on("stream", (stream) => {
          remoteAudio.srcObject = stream;
        });

        call.on("close", () => {
          endCall();
        });
      }

      let pendingCall = null;

      peer.on("call", async (call) => {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        pendingCall = call;
        callerIdSpan.textContent = call.peer;
        incomingCallUI.style.display = "block";
        ringtone.play();
      });

      function startCallTimer() {
        callTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          const min = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const sec = String(elapsed % 60).padStart(2, "0");
          callTimerSpan.textContent = `${min}:${sec}`;
        }, 1000);
      }

      function stopCallTimer() {
        clearInterval(callTimerInterval);
        callTimerSpan.textContent = "00:00";
      }
    </script>
  </body>
</html>
