<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Call</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 400px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 10px #ccc;
      }

      input {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      button {
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 5px;
      }

      button:hover {
        background: #0056b3;
      }

      #users button {
        margin-right: 5px;
        margin-top: 5px;
      }

      .qr {
        text-align: center;
        margin-bottom: 10px;
      }

      #incoming-call {
        display: none;
        background: #fffbcc;
        border: 1px solid #999;
        padding: 15px;
        margin-top: 10px;
        text-align: center;
        border-radius: 10px;
      }

      #incoming-call button {
        background: #28a745;
        margin-right: 10px;
      }

      #incoming-call .decline {
        background: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üéß Audio Call</h2>
      <p>Your ID: <span id="my-id">Loading...</span></p>

      <div class="qr">
        <canvas id="qrCanvas"></canvas>
        <p><button onclick="copyID()">üìã Copy ID</button></p>
      </div>

      <input type="text" id="peer-id" placeholder="Enter Peer ID" />
      <button onclick="addUser()">‚ûï Add User</button>
      <div id="users"></div>

      <div id="incoming-call">
        <p>
          <strong>üìû Incoming call from <span id="caller-id"></span></strong>
        </p>
        <button onclick="acceptCall()">‚úÖ Accept</button>
        <button class="decline" onclick="declineCall()">‚ùå Decline</button>
      </div>

      <hr />
      <audio id="remote-audio" autoplay></audio>
    </div>

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>

    <script>
      let myID = localStorage.getItem("fixedID");
      if (!myID) {
        myID = "user_" + Math.random().toString(36).substring(2, 8);
        localStorage.setItem("fixedID", myID);
      }

      const peer = new Peer(myID);
      const remoteAudio = document.getElementById("remote-audio");
      const myIdSpan = document.getElementById("my-id");
      const usersDiv = document.getElementById("users");
      const peerIdInput = document.getElementById("peer-id");
      const incomingDiv = document.getElementById("incoming-call");
      const callerSpan = document.getElementById("caller-id");

      let currentCall = null;
      let savedStream = null;
      let incomingCall = null;

      peer.on("open", (id) => {
        myIdSpan.textContent = id;
        generateQR(id);
        loadUsers();
      });

      peer.on("call", (call) => {
        incomingCall = call;
        callerSpan.textContent = call.peer;
        incomingDiv.style.display = "block";
      });

      function acceptCall() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          savedStream = stream;
          incomingCall.answer(stream);
          incomingCall.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
          });
          incomingDiv.style.display = "none";
        });
      }

      function declineCall() {
        if (incomingCall) {
          incomingCall.close();
        }
        incomingDiv.style.display = "none";
      }

      function callUser(id) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          savedStream = stream;
          const call = peer.call(id, stream);
          currentCall = call;
          call.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
          });
        });
      }

      function addUser() {
        const id = peerIdInput.value.trim();
        if (!id) return;

        let users = JSON.parse(localStorage.getItem("userList") || "[]");
        if (!users.includes(id) && id !== myID) {
          users.push(id);
          localStorage.setItem("userList", JSON.stringify(users));
          loadUsers();
        }
        peerIdInput.value = "";
      }

      function loadUsers() {
        usersDiv.innerHTML = "";
        let users = JSON.parse(localStorage.getItem("userList") || "[]");

        users.forEach((id) => {
          const btn = document.createElement("button");
          btn.textContent = `üìû Call ${id}`;
          btn.onclick = () => callUser(id);

          const del = document.createElement("button");
          del.textContent = "‚ùå";
          del.onclick = () => removeUser(id);

          usersDiv.appendChild(btn);
          usersDiv.appendChild(del);
        });
      }

      function removeUser(id) {
        let users = JSON.parse(localStorage.getItem("userList") || "[]");
        users = users.filter((u) => u !== id);
        localStorage.setItem("userList", JSON.stringify(users));
        loadUsers();
      }

      function generateQR(id) {
        const qr = new QRious({
          element: document.getElementById("qrCanvas"),
          value: id,
          size: 150,
        });
      }

      function copyID() {
        navigator.clipboard.writeText(myID);
        alert("Copied your ID!");
      }
    </script>
  </body>
</html>
