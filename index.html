<!DOCTYPE html>
<html>
  <head>
    <title>Video Call with PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        text-align: center;
        font-family: sans-serif;
      }
      input,
      button {
        margin: 10px;
        padding: 5px;
      }
      video {
        width: 45%;
        border: 2px solid black;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ“ž PeerJS Video Call</h2>
    <p>Your ID: <span id="my-id"></span></p>
    <input type="text" id="remote-id" placeholder="Friend's ID" />
    <button id="call-btn">Start Call</button>

    <div>
      <video id="local-video" autoplay muted></video>
      <video id="remote-video" autoplay></video>
    </div>

    <script>
      const peer = new Peer({
        // Optional: Use a custom PeerServer for better stability
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" }, // public STUN
            {
              urls: "turn:relay1.expressturn.com:3478",
              username: "ef3G7b9WZx8z5JW3wV5i5Q==",
              credential: "L+gRMbRUzIGjcS4HwFhGma8smow=",
            },
          ],
        },
      });

      const myIdEl = document.getElementById("my-id");
      const remoteIdInput = document.getElementById("remote-id");
      const callBtn = document.getElementById("call-btn");
      const localVideo = document.getElementById("local-video");
      const remoteVideo = document.getElementById("remote-video");

      let localStream;

      // Step 1: Get webcam/mic
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localVideo.srcObject = stream;
          localStream = stream;
        })
        .catch((err) => {
          alert("Failed to get media: " + err.message);
        });

      // Step 2: Show my ID
      peer.on("open", (id) => {
        myIdEl.textContent = id;
      });

      // Step 3: Answer incoming call
      peer.on("call", (call) => {
        call.answer(localStream);
        call.on("stream", (remoteStream) => {
          remoteVideo.srcObject = remoteStream;
        });
      });

      // Step 4: Call friend
      callBtn.onclick = () => {
        const remoteId = remoteIdInput.value.trim();
        if (!remoteId || !localStream)
          return alert("Missing friend's ID or camera access.");

        const call = peer.call(remoteId, localStream);
        call.on("stream", (remoteStream) => {
          remoteVideo.srcObject = remoteStream;
        });
      };
    </script>
  </body>
</html>
