<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real Audio Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f0f0f0;
        color: #333;
      }
      #my-id {
        font-size: 1.2rem;
        margin-bottom: 10px;
      }
      #users-list button {
        display: block;
        margin: 5px 0;
      }
      #incoming-call {
        display: none;
        background: #fff;
        border: 1px solid #aaa;
        padding: 15px;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10;
      }
      #call-info {
        margin-top: 20px;
        font-size: 1.2rem;
      }
      button {
        padding: 8px 16px;
        font-size: 1rem;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>üìû Real Audio Call System</h2>
    <div id="my-id">Your ID: <span id="peer-id">...</span></div>

    <input type="text" id="add-user-id" placeholder="Enter user ID to add" />
    <button onclick="addUser()">‚ûï Add User</button>

    <h3>Saved Users:</h3>
    <div id="users-list"></div>

    <div id="incoming-call">
      <p>
        <b>üì≤ Incoming Call from <span id="caller-id"></span></b>
      </p>
      <button onclick="answerCall()">‚úÖ Answer</button>
      <button onclick="declineCall()">‚ùå Decline</button>
    </div>

    <div id="call-info" style="display: none">
      <p>üìû In Call with: <span id="current-user"></span></p>
      <p>‚è±Ô∏è Duration: <span id="call-timer">0s</span></p>
      <button onclick="endCall()">üî¥ End Call</button>
    </div>

    <!-- Audio Elements -->
    <audio
      id="ringtone"
      src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_ringtones.ogg"
      loop
    ></audio>
    <audio id="remote-audio" autoplay></audio>

    <script>
      const myPeerId =
        localStorage.getItem("fixedPeerId") ||
        Math.random().toString(36).substring(2, 10);
      localStorage.setItem("fixedPeerId", myPeerId);
      document.getElementById("peer-id").textContent = myPeerId;

      const peer = new Peer(myPeerId, {
        debug: 2,
      });

      const ringtone = document.getElementById("ringtone");
      const remoteAudio = document.getElementById("remote-audio");

      let callConnection = null;
      let localStream = null;
      let currentCallWith = "";
      let callStartTime = null;
      let timerInterval = null;
      let incomingCall = null;

      const users = JSON.parse(localStorage.getItem("usersList") || "[]");
      function saveUsers() {
        localStorage.setItem("usersList", JSON.stringify(users));
        showUsers();
      }

      function addUser() {
        const id = document.getElementById("add-user-id").value.trim();
        if (id && !users.includes(id) && id !== myPeerId) {
          users.push(id);
          saveUsers();
        }
        document.getElementById("add-user-id").value = "";
      }

      function showUsers() {
        const list = document.getElementById("users-list");
        list.innerHTML = "";
        users.forEach((uid) => {
          const btn = document.createElement("button");
          btn.textContent = "üìû Call " + uid;
          btn.onclick = () => startCall(uid);
          list.appendChild(btn);
        });
      }

      showUsers();

      function startCall(remoteId) {
        if (callConnection) return alert("Already in a call.");
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          localStream = stream;
          const call = peer.call(remoteId, stream);
          callConnection = call;
          currentCallWith = remoteId;
          callStartTime = Date.now();
          document.getElementById("current-user").textContent = remoteId;
          document.getElementById("call-info").style.display = "block";
          startTimer();

          call.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
          });

          call.on("close", endCallUI);
        });
      }

      function answerCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById("incoming-call").style.display = "none";
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          localStream = stream;
          incomingCall.answer(stream);
          callConnection = incomingCall;
          currentCallWith = incomingCall.peer;
          callStartTime = Date.now();
          document.getElementById("current-user").textContent =
            incomingCall.peer;
          document.getElementById("call-info").style.display = "block";
          startTimer();

          incomingCall.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
          });

          incomingCall.on("close", endCallUI);
          incomingCall = null;
        });
      }

      function declineCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        document.getElementById("incoming-call").style.display = "none";
        if (incomingCall) {
          incomingCall.close();
          incomingCall = null;
        }
      }

      function endCall() {
        if (callConnection) {
          callConnection.close();
          callConnection = null;
          stopTimer();
        }
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
        endCallUI();
      }

      function endCallUI() {
        document.getElementById("call-info").style.display = "none";
        document.getElementById("call-timer").textContent = "0s";
        currentCallWith = "";
        stopTimer();
      }

      function startTimer() {
        timerInterval = setInterval(() => {
          const seconds = Math.floor((Date.now() - callStartTime) / 1000);
          document.getElementById("call-timer").textContent = `${seconds}s`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      peer.on("call", (call) => {
        if (callConnection) {
          call.close(); // already in call
          return;
        }
        incomingCall = call;
        document.getElementById("caller-id").textContent = call.peer;
        document.getElementById("incoming-call").style.display = "block";
        ringtone.play();
      });
    </script>
  </body>
</html>
