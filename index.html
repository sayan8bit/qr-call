<!DOCTYPE html>
<html>
  <head>
    <title>Audio Call System</title>
    <style>
      body {
        font-family: sans-serif;
        background: #111;
        color: white;
        padding: 20px;
      }
      #users button {
        margin: 5px;
        padding: 5px 10px;
      }
      .incoming {
        background: #333;
        padding: 10px;
        margin-top: 10px;
      }
      #callControls,
      #incomingCall {
        display: none;
        margin-top: 10px;
      }
      audio {
        display: none;
      }
      .ringing {
        color: orange;
      }
    </style>
  </head>
  <body>
    <h2>My ID: <span id="myId"></span></h2>

    <input id="userIdInput" placeholder="Enter User ID to call" />
    <button onclick="addUser()">Add User</button>

    <h3>Saved Users</h3>
    <div id="users"></div>

    <div id="incomingCall" class="incoming">
      <p id="incomingFrom"></p>
      <button onclick="answerCall()">Answer</button>
      <button onclick="declineCall()">Decline</button>
    </div>

    <div id="callControls">
      <p><span id="callStatus">Calling...</span> <span id="callTime"></span></p>
      <button onclick="endCall()">End Call</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
    <audio
      id="ringtone"
      src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg"
      loop
    ></audio>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
      const myId =
        localStorage.getItem("peer-id") ||
        `user-${Math.random().toString(36).substr(2, 5)}`;
      localStorage.setItem("peer-id", myId);
      document.getElementById("myId").textContent = myId;

      const peer = new Peer(myId, { debug: 2 });
      let currentCall = null;
      let callTimer = null;
      let callStartTime = null;
      const ringtone = document.getElementById("ringtone");
      const remoteAudio = document.getElementById("remoteAudio");

      // Load saved users
      const savedUsers = JSON.parse(
        localStorage.getItem("saved-users") || "[]"
      );
      function renderUsers() {
        const usersDiv = document.getElementById("users");
        usersDiv.innerHTML = "";
        savedUsers.forEach((id) => {
          const btn = document.createElement("button");
          btn.textContent = id;
          btn.onclick = () => callUser(id);
          usersDiv.appendChild(btn);
        });
      }
      renderUsers();

      function addUser() {
        const id = document.getElementById("userIdInput").value.trim();
        if (id && !savedUsers.includes(id) && id !== myId) {
          savedUsers.push(id);
          localStorage.setItem("saved-users", JSON.stringify(savedUsers));
          renderUsers();
          document.getElementById("userIdInput").value = "";
        }
      }

      async function callUser(targetId) {
        stopAudio(); // stop anything before
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const call = peer.call(targetId, stream);
        handleCall(call, stream, true);
      }

      peer.on("call", async (incomingCall) => {
        ringtone.play();
        window.incomingCall = incomingCall;
        document.getElementById(
          "incomingFrom"
        ).textContent = `Incoming call from ${incomingCall.peer}`;
        document.getElementById("incomingCall").style.display = "block";
      });

      async function answerCall() {
        document.getElementById("incomingCall").style.display = "none";
        ringtone.pause();
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        window.incomingCall.answer(stream);
        handleCall(window.incomingCall, stream, false);
      }

      function declineCall() {
        document.getElementById("incomingCall").style.display = "none";
        ringtone.pause();
        window.incomingCall.close();
      }

      function handleCall(call, localStream, isCaller) {
        if (currentCall) currentCall.close(); // Only one call at a time
        currentCall = call;

        document.getElementById("callControls").style.display = "block";
        document.getElementById("callStatus").textContent = isCaller
          ? "Calling..."
          : "In Call";

        call.on("stream", (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          remoteAudio.play();
          document.getElementById("callStatus").textContent = "In Call";
          startTimer();
        });

        call.on("close", () => {
          endCall(true);
        });

        call.on("error", (err) => {
          console.error("Call error:", err);
          endCall(true);
        });
      }

      function endCall(fromRemote = false) {
        if (currentCall) {
          currentCall.close();
          currentCall = null;
        }
        stopAudio();
        stopTimer();
        document.getElementById("callControls").style.display = "none";
        if (!fromRemote) peer.disconnect(); // Trigger other side to close too
      }

      function stopAudio() {
        if (remoteAudio.srcObject) {
          remoteAudio.srcObject.getTracks().forEach((t) => t.stop());
          remoteAudio.srcObject = null;
        }
      }

      function startTimer() {
        callStartTime = Date.now();
        callTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const secs = String(elapsed % 60).padStart(2, "0");
          document.getElementById("callTime").textContent = `${mins}:${secs}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(callTimer);
        document.getElementById("callTime").textContent = "";
      }
    </script>
  </body>
</html>
