<!DOCTYPE html>
<html>
  <head>
    <title>Real Audio Call - PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #f0f0f0;
      }
      #users {
        margin-top: 20px;
      }
      .user {
        background: white;
        padding: 10px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        border-radius: 5px;
      }
      button {
        margin-left: 5px;
      }
      #callControls {
        display: none;
        margin-top: 20px;
      }
      #incomingCall {
        display: none;
        background: #fff3cd;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ffeeba;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>PeerJS Audio Call</h2>
    <p><strong>Your ID:</strong> <span id="myId"></span></p>

    <input type="text" id="userIdInput" placeholder="Enter user ID to add" />
    <button onclick="addUser()">Add User</button>

    <div id="users"></div>

    <div id="incomingCall">
      <p>üìû Incoming call from <span id="callerId"></span></p>
      <button onclick="answerCall()">Answer</button>
      <button onclick="declineCall()">Decline</button>
    </div>

    <div id="callControls">
      <p>
        üîó In call with <span id="currentCallId"></span>
        <span id="callTimer">00:00</span>
      </p>
      <button onclick="endCall()">End Call</button>
    </div>

    <audio
      id="ringtone"
      src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg"
      loop
    ></audio>

    <script>
      let myId =
        localStorage.getItem("fixedId") ||
        "user-" + Math.random().toString(36).substring(2, 8);
      localStorage.setItem("fixedId", myId);
      document.getElementById("myId").textContent = myId;

      const peer = new Peer(myId, { debug: 2 });

      let conn;
      let currentCall;
      let callStartTime;
      let callTimerInterval;

      const ringtone = document.getElementById("ringtone");

      // ========== Load Saved Users ==========
      const usersDiv = document.getElementById("users");
      const savedUsers = JSON.parse(localStorage.getItem("users") || "[]");
      savedUsers.forEach((uid) => renderUser(uid));

      function addUser() {
        const id = document.getElementById("userIdInput").value.trim();
        if (!id || savedUsers.includes(id) || id === myId) return;
        savedUsers.push(id);
        localStorage.setItem("users", JSON.stringify(savedUsers));
        renderUser(id);
        document.getElementById("userIdInput").value = "";
      }

      function renderUser(id) {
        const div = document.createElement("div");
        div.className = "user";
        div.innerHTML = `<span>${id}</span>
      <span>
        <button onclick="callUser('${id}')">üìû Call</button>
        <button onclick="removeUser('${id}', this)">‚ùå</button>
      </span>`;
        usersDiv.appendChild(div);
      }

      function removeUser(id, btn) {
        const index = savedUsers.indexOf(id);
        if (index !== -1) savedUsers.splice(index, 1);
        localStorage.setItem("users", JSON.stringify(savedUsers));
        btn.closest(".user").remove();
      }

      // ========== Make a Call ==========
      async function callUser(id) {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const call = peer.call(id, stream);
        setupCall(call, stream, true);
      }

      // ========== Incoming Call ==========
      peer.on("call", async function (call) {
        window.incomingCall = call;
        document.getElementById("callerId").textContent = call.peer;
        document.getElementById("incomingCall").style.display = "block";
        ringtone.play();
      });

      async function answerCall() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        incomingCall.answer(stream);
        setupCall(incomingCall, stream, false);
        ringtone.pause();
        document.getElementById("incomingCall").style.display = "none";
      }

      function declineCall() {
        incomingCall.close();
        ringtone.pause();
        document.getElementById("incomingCall").style.display = "none";
      }

      function setupCall(call, localStream, isCaller) {
        currentCall = call;
        document.getElementById("callControls").style.display = "block";
        document.getElementById("currentCallId").textContent = call.peer;

        call.on("stream", (remoteStream) => {
          const audio = new Audio();
          audio.srcObject = remoteStream;
          audio.play();
        });

        call.on("close", () => {
          endCall();
        });

        startTimer();
      }

      function endCall() {
        if (currentCall) currentCall.close();
        document.getElementById("callControls").style.display = "none";
        document.getElementById("callTimer").textContent = "00:00";
        clearInterval(callTimerInterval);
      }

      function startTimer() {
        callStartTime = Date.now();
        callTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          const minutes = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const seconds = String(elapsed % 60).padStart(2, "0");
          document.getElementById(
            "callTimer"
          ).textContent = `${minutes}:${seconds}`;
        }, 1000);
      }
    </script>
  </body>
</html>
