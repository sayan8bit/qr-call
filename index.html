<!DOCTYPE html>
<html>
  <head>
    <title>PeerJS Video Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial;
        text-align: center;
        background: #f2f2f2;
        padding: 30px;
      }
      input,
      button {
        padding: 10px;
        margin: 10px 5px;
        width: 250px;
        font-size: 16px;
      }
      video {
        width: 40%;
        margin: 10px;
        border: 3px solid #444;
        border-radius: 10px;
      }
      #status {
        font-size: 18px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h2>üé• PeerJS Video Call</h2>

    <p><strong>Your ID:</strong> <span id="my-id">Loading...</span></p>

    <input type="text" id="peer-id" placeholder="Enter peer ID to call" />
    <br />
    <button onclick="startCall()">üìû Call</button>
    <button onclick="endCall()">‚ùå End Call</button>

    <p>Status: <span id="status">Waiting...</span></p>
    <p>Call Time: <span id="timer">00:00</span></p>

    <div>
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
    </div>

    <script>
      let localStream = null;
      let currentCall = null;
      let timerInterval = null;
      let startTime = null;

      // Persistent peer ID
      let myId = localStorage.getItem("peer-fixed-id");
      if (!myId) {
        myId = "user-" + Math.random().toString(36).substring(2, 6);
        localStorage.setItem("peer-fixed-id", myId);
      }

      const peer = new Peer(myId);

      peer.on("open", (id) => {
        document.getElementById("my-id").innerText = id;
      });

      peer.on("call", (call) => {
        updateStatus("Incoming call...");
        getMediaStream()
          .then((stream) => {
            localStream = stream;
            call.answer(stream);
            currentCall = call;
            setupCallEvents(call);
            document.getElementById("localVideo").srcObject = stream;
          })
          .catch((err) => {
            console.error("Mic/camera error:", err);
            updateStatus("Permission denied");
          });
      });

      function startCall() {
        const peerId = document.getElementById("peer-id").value;
        if (!peerId) return alert("Please enter peer ID to call.");

        getMediaStream()
          .then((stream) => {
            localStream = stream;
            document.getElementById("localVideo").srcObject = stream;
            const call = peer.call(peerId, stream);
            currentCall = call;
            updateStatus("Calling...");
            setupCallEvents(call);
          })
          .catch((err) => {
            console.error("Mic/camera error:", err);
            updateStatus("Permission denied");
          });
      }

      function getMediaStream() {
        return navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
      }

      function setupCallEvents(call) {
        call.on("stream", (remoteStream) => {
          document.getElementById("remoteVideo").srcObject = remoteStream;
          updateStatus("In Call");
          startTimer();
        });

        call.on("close", () => {
          updateStatus("Call Ended");
          document.getElementById("remoteVideo").srcObject = null;
          stopTimer();
        });
      }

      function endCall() {
        if (currentCall) {
          currentCall.close();
        }
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          document.getElementById("localVideo").srcObject = null;
        }
        document.getElementById("remoteVideo").srcObject = null;
        updateStatus("Call Ended");
        stopTimer();
      }

      function updateStatus(text) {
        document.getElementById("status").innerText = text;
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const secs = String(elapsed % 60).padStart(2, "0");
          document.getElementById("timer").innerText = `${mins}:${secs}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById("timer").innerText = "00:00";
      }
    </script>
  </body>
</html>
